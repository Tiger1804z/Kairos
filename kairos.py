from openai import OpenAI
import os
from dotenv import load_dotenv
from docx import Document
import fitz  # PyMuPDF

# === FONCTIONS UTILITAIRES ===
def lire_txt(path):
    with open(path, 'r', encoding='utf-8') as f:
        return f.read()

def lire_pdf(path):
    texte = ""
    with fitz.open(path) as doc:
        for page in doc:
            texte += page.get_text()
    return texte

def lire_docx(path):
    doc = Document(path)
    return "\n".join([para.text for para in doc.paragraphs])

def lire_fichier(path):
    extension = path.split('.')[-1].lower()
    if extension == 'txt':
        with open(path, 'r', encoding='utf-8') as f:
            return f.read()
    elif extension == 'pdf':
        return lire_pdf(path)
    elif extension == 'docx':
        return lire_docx(path)
    else:
        print("‚ùå Format non support√©. Utilise un fichier .txt, .pdf ou .docx")
        exit()

# === CONFIGURATION ===
load_dotenv()
api_key = os.getenv('OPENAI_API_KEY')
if not api_key:
    print("‚ùå Cl√© API manquante. V√©rifie ton fichier .env")
    exit()

client = OpenAI(api_key=api_key)

# === DEMANDE DE FICHIER ===
fichier = input("Nom du fichier (.txt, .pdf, .docx) √† r√©sumer : ")

if not os.path.exists(fichier):
    print(f"‚ùå Le fichier '{fichier}' est introuvable.")
    exit()

texte = lire_fichier(fichier)

# === APPEL √Ä L'API OPENAI ===
response = client.chat.completions.create(
    model="gpt-4o",
    messages=[
        {"role": "system", "content": "Tu es un assistant qui r√©sume les textes de mani√®re claire et concise."},
        {"role": "user", "content": f"R√©sume ce texte : {texte}"}
    ],
    temperature=0.5
)

# === AFFICHAGE ===
print("\nüìå R√©sum√© :\n")
print(response.choices[0].message.content)
