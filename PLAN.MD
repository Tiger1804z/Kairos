# ğŸ“‹ PLAN.MD - Projet Kairos

**DerniÃ¨re mise Ã  jour :** 2026-02-17
**Progression globale :** 70%
**Type de projet :** Projet scolaire (MVP pour prÃ©sentation)
**Focus actuel :** ğŸ“¦ **MVP Data-first** - Onboarding & Import CSV Intelligent assistÃ© par IA

---

## ğŸ¯ Vue d'ensemble du projet

**Kairos** est une plateforme MVP de gestion d'entreprise avec intelligence artificielle qui permet aux propriÃ©taires de PME de :
- Importer leurs donnÃ©es financiÃ¨res via un CSV intelligent assistÃ© par IA
- Visualiser leurs clients, transactions et engagements (lecture seule)
- Analyser leurs documents financiers automatiquement (OpenAI)
- Obtenir des insights via un assistant IA
- Visualiser leurs donnÃ©es via un dashboard interactif

**ğŸ“ Objectif scolaire :** PrÃ©senter un MVP fonctionnel avec import de donnÃ©es intelligent et pages read-only

**ğŸ“Œ Nouveau scope MVP :** Les pages (Clients, Transactions, Engagements, Reports, Settings) sont **read-only** : elles affichent les items et leurs dÃ©tails, mais pas de CRUD complet. Le seul "create" cÃ´tÃ© produit est l'**onboarding + import CSV intelligent**.

---

## ğŸ—ï¸ Architecture Technique

### Backend (Node.js + TypeScript)
- **Framework :** Express.js
- **Base de donnÃ©es :** PostgreSQL via Prisma ORM
- **Authentification :** JWT avec middleware `requireAuth`
- **SÃ©curitÃ© :** Business scoping avec `requireBusinessAccess`
- **Structure :** Architecture 3-couches (Routes â†’ Controllers â†’ Services)

### Frontend (React + TypeScript)
- **Framework :** React 18 + React Router
- **Styling :** TailwindCSS
- **State Management :** Context API (AuthContext, BusinessContext)
- **API Client :** Axios avec intercepteurs JWT

### Service Python (FastAPI)
- **Extraction de documents :** PDF, CSV, TXT
- **Communication :** HTTP avec le backend Node.js
- **Stockage :** Fichiers locaux structurÃ©s

---

## âœ… FonctionnalitÃ©s ImplÃ©mentÃ©es (85% backend)

### ğŸ” Authentification & Autorisation
- [x] Inscription utilisateur (signup)
- [x] Connexion (login)
- [x] Middleware JWT (`requireAuth`)
- [x] Protection des routes frontend (`RequireAuth`)
- [x] Context d'authentification (`AuthContext`)
- [x] Redirection vers login si non authentifiÃ©

### ğŸ‘¤ Gestion des Utilisateurs
- [x] Endpoint GET `/auth/me` - RÃ©cupÃ©rer l'utilisateur connectÃ©
- [x] SystÃ¨me de rÃ´les (owner, admin, employee)
- [x] Page de profil basique

### ğŸ¢ Gestion des Businesses
- [x] CRUD businesses complet
- [x] Middleware `requireBusinessAccess` (vÃ©rification ownership)
- [x] Context global `BusinessContext`
- [x] SÃ©lecteur de business dans le header
- [x] Persistance du business sÃ©lectionnÃ© (localStorage)

### ğŸ‘¥ Gestion des Clients
- [x] CRUD clients complet
- [x] Filtrage par business
- [x] Page liste des clients
- [x] Validation email unique par business

### ğŸ“„ Gestion des Documents
- [x] Upload de documents (multer)
- [x] Stockage structurÃ© par business/date
- [x] Extraction de contenu via service Python
- [x] Analyse IA (finance ou gÃ©nÃ©ral)
- [x] Persistance mÃ©tadonnÃ©es (Prisma)

### ğŸ’° Gestion des Transactions
- [x] CRUD transactions
- [x] Types : income/expense
- [x] MÃ©thodes de paiement
- [x] CatÃ©gorisation
- [x] Liaison avec clients/engagements

### ğŸ“Š Gestion des Engagements
- [x] CRUD engagements
- [x] Statuts (draft, active, completed, cancelled)
- [x] Items d'engagement (products, services, hourly, subscription)
- [x] Calcul des totaux

### ğŸ“ˆ Dashboard (COMPLET âœ…)
- [x] **Backend :**
  - [x] Service `dashboardService.ts` avec 5 fonctions
  - [x] Controller `dashboardController.ts`
  - [x] Routes `dashboardRoutes.ts` protÃ©gÃ©es
  - [x] Endpoint GET `/dashboard/metrics` (clients, engagements, revenu)
  - [x] Endpoint GET `/dashboard/top-clients` (top 5 par revenu)
  - [x] Endpoint GET `/dashboard/revenue-growth` (croissance mois par mois)
  - [x] Endpoint GET `/dashboard/monthly-trend` (revenu + dÃ©penses sur 6 mois)
  - [x] Endpoint GET `/dashboard/expenses-by-category` (dÃ©penses par catÃ©gorie)
- [x] **Frontend :**
  - [x] Hook `useDashboard()` pour fetch les donnÃ©es (5 endpoints en parallÃ¨le)
  - [x] Page `DashboardPage.tsx` avec vraies donnÃ©es API
  - [x] Composant `BusinessSelector` dans le header
  - [x] Affichage mÃ©triques principales
  - [x] Affichage top clients
  - [x] Affichage croissance du revenu
  - [x] Loading states et error handling
  - [x] Formatage monÃ©taire (CAD)
  - [x] **Composant `RevenueLineChart`** - Line chart revenu vs dÃ©penses (6 mois)
  - [x] **Composant `ExpensePieChart`** - Donut chart dÃ©penses par catÃ©gorie
  - [x] **Librairie Recharts** installÃ©e et intÃ©grÃ©e

### ğŸ¤– Intelligence Artificielle (COMPLET âœ…)
- [x] **Backend : Service `aiService.ts` complet avec OpenAI**
- [x] **Endpoint POST `/ai/ask`** - Questions naturelles â†’ SQL â†’ RÃ©ponses
- [x] **Endpoint GET `/ai/daily-finance-summary`** - RÃ©sumÃ© quotidien
- [x] GÃ©nÃ©ration de SQL sÃ©curisÃ© (`generateSQLFromQuestion`)
- [x] Validation SQL avec `sqlGuard`
- [x] Analyse de documents financiers (PDF, CSV)
- [x] DÃ©tection automatique du type de document
- [x] GÃ©nÃ©ration de rÃ©sumÃ©s avec GPT-4o-mini
- [x] Logging automatique des requÃªtes (`QueryLog`)
- [x] CrÃ©ation automatique de rapports (`Report`)
- [x] Support multi-intents (revenus, dÃ©penses, net, par catÃ©gorie)
- [x] **Frontend : Hook `useAskKairos()` crÃ©Ã©**
- [x] **Frontend : `AskKairosInput` connectÃ© Ã  l'API**
- [x] **Frontend : Affichage des rÃ©ponses de l'IA dans le Dashboard**
- [x] **Frontend : Gestion des erreurs et loading states**

### ğŸ“Š Rapports & Logs
- [x] QueryLogs (historique des requÃªtes IA)
- [x] Rapports gÃ©nÃ©rÃ©s
- [x] Persistance en base de donnÃ©es

---

## ğŸ“¦ Onboarding & Import CSV Intelligent (MVP Data-first)

### ğŸ¯ Concept

Le MVP adopte une approche **"Data-first"** : plutÃ´t que de proposer un CRUD complet sur chaque entitÃ©, l'utilisateur importe ses donnÃ©es existantes via un **import CSV intelligent assistÃ© par IA**, puis navigue dans ses donnÃ©es en **lecture seule** via les diffÃ©rentes pages.

Le seul flux de crÃ©ation est l'**onboarding** (crÃ©ation du business + import des donnÃ©es).

### ğŸ”„ Flow UX complet

#### Step 0 : Redirect automatique
- Si l'utilisateur est authentifiÃ© mais n'a **aucun business** ou **aucune donnÃ©e**, redirection automatique vers `/onboarding`
- VÃ©rification cÃ´tÃ© frontend via `BusinessContext`

#### Step 1 : Formulaire Business Info
- **Champs obligatoires :**
  - `name` : Nom de l'entreprise
  - `currency` : Devise (CAD, USD, EUR...)
- **Champs optionnels :**
  - `industry` : Secteur d'activitÃ© (dropdown)
  - `timezone` : Fuseau horaire (dÃ©faut : America/Montreal)

#### Step 2 : Choix du mode d'import
- **Option A : Import CSV intelligent** (recommandÃ©) â†’ Step 3
- **Option B : DonnÃ©es de dÃ©monstration** (seed) â†’ Insertion des donnÃ©es de test existantes â†’ Step 4

#### Step 3 : Wizard d'import CSV
1. **Upload du fichier CSV** : Drag & drop ou sÃ©lection de fichier
2. **Preview** : Affichage des 10 premiÃ¨res lignes du CSV dans un tableau
3. **DÃ©tection automatique** : Matching heuristique des colonnes (voir section Import Intelligent)
4. **Suggestion de mapping IA** : Si colonnes ambiguÃ«s, appel Ã  OpenAI pour suggÃ©rer le mapping
5. **Ã‰dition manuelle du mapping** : L'utilisateur peut corriger/modifier les associations proposÃ©es
6. **Validation** : VÃ©rification des donnÃ©es avant import (types, formats, champs requis)
7. **Import** : Lancement de l'import en backend avec barre de progression

#### Step 4 : RÃ©sultat de l'import
- Nombre de lignes importÃ©es avec succÃ¨s
- Nombre de lignes ignorÃ©es (doublons, donnÃ©es invalides)
- Erreurs dÃ©taillÃ©es (numÃ©ro de ligne + message d'erreur)
- Bouton **"Aller au Dashboard"** pour accÃ©der Ã  l'application

---

### ğŸ“„ Format CSV MVP

#### Colonnes minimum requises

| Colonne | Type | Description |
|---------|------|-------------|
| `date` | string | Date de la transaction (formats acceptÃ©s ci-dessous) |
| `type` | string | Type : `income`, `expense` (ou synonymes dÃ©tectÃ©s automatiquement) |
| `amount` | number | Montant (positif) |

#### Colonnes optionnelles

| Colonne | Type | Description |
|---------|------|-------------|
| `category` | string | CatÃ©gorie (ex: "Marketing", "Salaire", "Vente") |
| `client_name` | string | Nom du client associÃ© |
| `description` | string | Description / libellÃ© |
| `payment_method` | string | MÃ©thode de paiement (cash, card, transfer, other) |
| `reference_number` | string | NumÃ©ro de rÃ©fÃ©rence / facture |

#### Formats de date acceptÃ©s
- `YYYY-MM-DD` (ISO 8601)
- `DD/MM/YYYY`
- `MM/DD/YYYY`
- `YYYY/MM/DD`

---

### ğŸ§  SystÃ¨me d'Import Intelligent

#### Ã‰tape 1 : DÃ©tection automatique des colonnes (heuristique)

Matching basÃ© sur lowercase + trim + synonymes connus :

| Header CSV dÃ©tectÃ© | Mapping Kairos |
|-------------------|----------------|
| `date`, `transaction_date`, `trans_date` | `date` |
| `revenue`, `income`, `revenu`, `entrÃ©e` | `type: income` |
| `cost`, `expense`, `dÃ©pense`, `sortie` | `type: expense` |
| `amount`, `montant`, `total`, `sum` | `amount` |
| `category`, `catÃ©gorie`, `cat` | `category` |
| `client`, `client_name`, `customer`, `nom_client` | `client_name` |
| `description`, `desc`, `libellÃ©`, `label`, `memo` | `description` |
| `payment`, `payment_method`, `mode_paiement` | `payment_method` |
| `reference`, `ref`, `reference_number`, `invoice` | `reference_number` |

#### Ã‰tape 2 : Appel IA pour colonnes ambiguÃ«s

Si certaines colonnes du CSV ne sont pas reconnues par l'heuristique :
- **Envoi Ã  OpenAI** : uniquement les **headers + 5 premiÃ¨res lignes** du CSV (jamais la base complÃ¨te)
- **Prompt structurÃ©** : demander Ã  l'IA de retourner un mapping JSON `{ csvColumn â†’ kairosField }`
- **Validation backend** : le mapping suggÃ©rÃ© par l'IA est **validÃ© cÃ´tÃ© backend** avant toute application
- L'IA ne touche **jamais** directement Ã  la base de donnÃ©es

#### Ã‰tape 3 : Normalisation en TypeScript (backend Node.js)

Toute la normalisation est faite cÃ´tÃ© backend, jamais par l'IA :

1. **Parsing des dates** : DÃ©tection du format parmi les formats acceptÃ©s, conversion en `Date` ISO
2. **Parsing des montants** : Gestion des virgules (`1 234,56` â†’ `1234.56`), points, espaces
3. **Mapping du type** : Normalisation vers l'enum `income` / `expense` (synonymes supportÃ©s)
4. **Normalisation des catÃ©gories** : lowercase, trim, fallback vers `"other"` si vide ou inconnu
5. **CrÃ©ation automatique des clients** : Si `client_name` fourni et client inexistant dans le business â†’ crÃ©ation automatique (dÃ©duplication case-insensitive)
6. **Scoping business** : Toutes les insertions incluent le `business_id` de l'utilisateur
7. **DÃ©duplication** : VÃ©rification case-insensitive pour Ã©viter les doublons (mÃªme date + mÃªme montant + mÃªme description = doublon potentiel â†’ marquÃ© comme skipped)

---

### ğŸ”Œ Endpoints Backend

#### Onboarding

| MÃ©thode | Route | Description |
|---------|-------|-------------|
| `POST` | `/onboarding/business` | CrÃ©ation du business pendant l'onboarding (name, currency, industry?, timezone?) |

#### Import CSV

| MÃ©thode | Route | Description |
|---------|-------|-------------|
| `POST` | `/import/transactions/preview` | Upload CSV + retourne preview (10 lignes) + mapping suggÃ©rÃ© (heuristique + IA si nÃ©cessaire) |
| `POST` | `/import/transactions` | Lancement de l'import avec le mapping validÃ© par l'utilisateur |
| `GET` | `/import/jobs` | Liste des jobs d'import pour le business courant |
| `GET` | `/import/jobs/:id` | DÃ©tail d'un job d'import (statut, compteurs, erreurs) |

Tous les endpoints sont protÃ©gÃ©s par `requireAuth` + `requireBusinessAccess`.

---

### ğŸ—ƒï¸ Nouveaux ModÃ¨les Prisma

```prisma
model ImportJob {
  id             String           @id @default(uuid())
  business_id    String
  business       Business         @relation(fields: [business_id], references: [id])
  filename       String
  status         ImportJobStatus  @default(PENDING)
  inserted_count Int              @default(0)
  skipped_count  Int              @default(0)
  error_count    Int              @default(0)
  created_at     DateTime         @default(now())
  errors         ImportRowError[]
}

model ImportRowError {
  id           String    @id @default(uuid())
  job_id       String
  job          ImportJob @relation(fields: [job_id], references: [id])
  row_number   Int
  message      String
  raw_row_json Json
}

enum ImportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
```

---

### ğŸ“± Mise Ã  jour des Pages (Read-Only)

Les pages passent en mode **lecture seule** : affichage des donnÃ©es importÃ©es, pas de formulaires de crÃ©ation/Ã©dition.

| Page | Route | Contenu |
|------|-------|---------|
| **Clients** | `/dashboard/clients` | Table des clients + page dÃ©tail client (historique transactions associÃ©es) |
| **Transactions** | `/dashboard/transactions` | Table des transactions + filtres (date, type, catÃ©gorie) + totaux income/expense/net |
| **Engagements** | `/dashboard/engagements` | Liste des engagements + badges de statut (draft, active, completed, cancelled) |
| **Reports** | `/dashboard/reports` | Historique des QueryLogs + rapports gÃ©nÃ©rÃ©s par l'IA |
| **Settings** | `/dashboard/settings` | Infos business (read-only) + actions : "Re-import CSV" + "RÃ©initialiser donnÃ©es dÃ©mo" |

---

### ğŸ”’ SÃ©curitÃ© & Isolation

1. **L'IA ne reÃ§oit jamais la base complÃ¨te** : seuls les headers + un Ã©chantillon de 5 lignes du CSV sont envoyÃ©s Ã  OpenAI
2. **L'IA ne touche jamais la base de donnÃ©es** : elle retourne un mapping JSON, le backend valide et applique
3. **Validation stricte cÃ´tÃ© backend** : tous les champs sont validÃ©s (types, formats, longueurs) avant insertion
4. **Scoping par `business_id`** : toutes les donnÃ©es sont isolÃ©es par business, aucun accÃ¨s croisÃ© possible
5. **Middleware `requireBusinessAccess`** : vÃ©rifie que l'utilisateur a accÃ¨s au business ciblÃ© sur chaque endpoint
6. **Pas de donnÃ©es sensibles envoyÃ©es Ã  l'IA** : aucun montant rÃ©el, aucune info client n'est envoyÃ©e lors du mapping

---

## ğŸš§ En Cours de DÃ©veloppement

**Phase 2 : Frontend Onboarding (wizard multi-Ã©tapes + import CSV)**

---

## ğŸ“ FonctionnalitÃ©s Ã  ImplÃ©menter - MVP Data-first

### ğŸ¯ PRIORITÃ‰ MVP - Ã€ FAIRE

#### 1. ğŸ¤– ~~Connecter l'Assistant IA~~ âœ… TERMINÃ‰ (2026-02-06)
- [x] **Frontend uniquement - Backend dÃ©jÃ  fait âœ…**
  - [x] Hook `useAskKairos()` pour appeler POST `/ai/ask`
  - [x] Connecter `AskKairosInput` au backend
  - [x] Afficher les rÃ©ponses de l'IA dans une Card
  - [x] Loading state pendant la gÃ©nÃ©ration
  - [x] Afficher le SQL gÃ©nÃ©rÃ© (optionnel)
  - [x] Gestion d'erreurs (unsafe SQL, erreur serveur)

#### 2. ğŸ“Š ~~Dashboard - Graphiques~~ âœ… TERMINÃ‰ (2026-02-15)
- [x] Installer Recharts
- [x] Graphique de croissance du revenu (line chart) - 6 mois
- [x] Graphique rÃ©partition dÃ©penses par catÃ©gorie (donut chart)
- [x] Responsive via ResponsiveContainer
- [x] DonnÃ©es de test ajoutÃ©es (20 transactions seed)

#### 3. ğŸ“¦ Onboarding & Import CSV Intelligent (Ã€ FAIRE)
- [ ] Step 0 : Redirect vers `/onboarding` si aucun business/donnÃ©es
- [ ] Step 1 : Formulaire Business Info
- [ ] Step 2 : Choix du mode (CSV / Demo data)
- [ ] Step 3 : Wizard d'import CSV complet
- [ ] Step 4 : Page rÃ©sultat d'import

#### 4. ğŸ“– Pages Read-Only (Ã€ FAIRE)
- [ ] Page Clients (table + dÃ©tail)
- [ ] Page Transactions (table + filtres + totaux)
- [ ] Page Engagements (list + badges statut)
- [ ] Page Reports (historique QueryLog + rapports)
- [ ] Page Settings (infos business + actions re-import)

### ğŸ”® HORS SCOPE MVP - Pour release future
_Ces fonctionnalitÃ©s ne sont PAS nÃ©cessaires pour la prÃ©sentation scolaire_

<details>
<summary>FonctionnalitÃ©s post-MVP (cliquer pour voir)</summary>

#### CRUD complet
- [ ] Formulaires de crÃ©ation/Ã©dition clients
- [ ] Formulaires de crÃ©ation/Ã©dition transactions
- [ ] Formulaires de crÃ©ation/Ã©dition engagements

#### Documents
- [ ] Preview et tÃ©lÃ©chargement
- [ ] Recherche full-text

#### Transactions
- [ ] RÃ©conciliation bancaire

#### Engagements
- [ ] GÃ©nÃ©ration de factures PDF
- [ ] Envoi par email

#### Rapports
- [ ] GÃ©nÃ©rateur personnalisÃ©
- [ ] Export multi-formats

#### ParamÃ¨tres
- [ ] Changement de mot de passe

#### Notifications
- [ ] SystÃ¨me temps rÃ©el
- [ ] Email notifications

#### Multi-utilisateurs
- [ ] Invitation d'Ã©quipe
- [ ] Gestion permissions avancÃ©e

#### DÃ©ploiement
- [ ] DÃ©ploiement Vercel (hors scope pour l'instant)
</details>

---

## ğŸ—‚ï¸ Structure des Fichiers

### Backend (`Kairos-backend/`)
```
src/
â”œâ”€â”€ controllers/     # Logique HTTP (req/res)
â”‚   â”œâ”€â”€ authController.ts
â”‚   â”œâ”€â”€ dashboardController.ts
â”‚   â”œâ”€â”€ clientController.ts
â”‚   â”œâ”€â”€ onboardingController.ts    â† NOUVEAU
â”‚   â”œâ”€â”€ importController.ts        â† NOUVEAU
â”‚   â””â”€â”€ ...
â”œâ”€â”€ services/       # Logique mÃ©tier + DB
â”‚   â”œâ”€â”€ authService.ts
â”‚   â”œâ”€â”€ dashboardService.ts
â”‚   â”œâ”€â”€ clientsService.ts
â”‚   â”œâ”€â”€ onboardingService.ts       â† NOUVEAU
â”‚   â”œâ”€â”€ importService.ts           â† NOUVEAU
â”‚   â”œâ”€â”€ csvParserService.ts        â† NOUVEAU
â”‚   â”œâ”€â”€ columnMappingService.ts    â† NOUVEAU
â”‚   â””â”€â”€ ...
â”œâ”€â”€ routes/         # DÃ©finition des endpoints
â”‚   â”œâ”€â”€ authRoutes.ts
â”‚   â”œâ”€â”€ dashboardRoutes.ts
â”‚   â”œâ”€â”€ clientRoutes.ts
â”‚   â”œâ”€â”€ onboardingRoutes.ts        â† NOUVEAU
â”‚   â”œâ”€â”€ importRoutes.ts            â† NOUVEAU
â”‚   â””â”€â”€ ...
â”œâ”€â”€ middleware/     # Middlewares Express
â”‚   â”œâ”€â”€ authMiddleware.ts
â”‚   â””â”€â”€ requireBusinessAccess.ts
â”œâ”€â”€ prisma/         # Client Prisma
â””â”€â”€ index.ts        # Point d'entrÃ©e
```

### Frontend (`kairos-frontend/`)
```
src/
â”œâ”€â”€ pages/          # Pages React
â”‚   â”œâ”€â”€ auth/       # Login/Signup
â”‚   â”œâ”€â”€ dashboard/  # Dashboard principal
â”‚   â”œâ”€â”€ onboarding/ # Wizard onboarding + import     â† NOUVEAU
â”‚   â”‚   â”œâ”€â”€ OnboardingPage.tsx
â”‚   â”‚   â”œâ”€â”€ BusinessInfoStep.tsx
â”‚   â”‚   â”œâ”€â”€ ImportModeStep.tsx
â”‚   â”‚   â”œâ”€â”€ CsvWizardStep.tsx
â”‚   â”‚   â””â”€â”€ ImportResultStep.tsx
â”‚   â”œâ”€â”€ clients/    # Page clients read-only          â† NOUVEAU
â”‚   â”œâ”€â”€ transactions/ # Page transactions read-only   â† NOUVEAU
â”‚   â”œâ”€â”€ engagements/  # Page engagements read-only    â† NOUVEAU
â”‚   â”œâ”€â”€ reports/    # Page reports read-only           â† NOUVEAU
â”‚   â”œâ”€â”€ settings/   # Page settings                    â† NOUVEAU
â”‚   â””â”€â”€ landing/    # Page d'accueil
â”œâ”€â”€ components/     # Composants rÃ©utilisables
â”‚   â”œâ”€â”€ dashboard/  # BusinessSelector, RevenueLineChart, ExpensePieChart
â”‚   â”œâ”€â”€ import/     # CsvUploader, ColumnMapper, PreviewTable  â† NOUVEAU
â”‚   â”œâ”€â”€ layout/     # Layout (Sidebar, Header)
â”‚   â”œâ”€â”€ ui/         # Composants UI de base
â”‚   â””â”€â”€ kairos/     # AskKairosInput
â”œâ”€â”€ hooks/          # Custom hooks
â”‚   â”œâ”€â”€ useDashboard.ts
â”‚   â””â”€â”€ useImport.ts   â† NOUVEAU
â”œâ”€â”€ business/       # BusinessContext
â”‚   â””â”€â”€ BusinessContext.tsx
â”œâ”€â”€ auth/           # AuthContext
â”‚   â””â”€â”€ AuthContext.tsx
â”œâ”€â”€ lib/            # Utils
â”‚   â”œâ”€â”€ api.ts      # Client Axios
â”‚   â””â”€â”€ constants.ts
â””â”€â”€ app/            # Config app
    â”œâ”€â”€ App.tsx
    â”œâ”€â”€ router.tsx
    â””â”€â”€ providers.tsx
```

---

## âœ… Checklist MVP Data-first â€“ Import Intelligent

### Phase 1 : Backend Import (PrioritÃ© haute) âœ… TERMINÃ‰ (2026-02-17)
- [x] 1. CrÃ©er les modÃ¨les Prisma `ImportJob` + `ImportRowError` + migration
- [x] 2. CrÃ©er `csvParserService.ts` : parsing CSV + preview 10 lignes
- [x] 3. CrÃ©er `columnMappingService.ts` : heuristique de matching des colonnes
- [x] 4. IntÃ©grer l'appel OpenAI pour le mapping IA des colonnes ambiguÃ«s
- [x] 5. CrÃ©er `importService.ts` : normalisation + validation + insertion en base
- [x] 6. `onboardingService.ts` : skip â€” `businessService.ts` fait dÃ©jÃ  le job
- [x] 7. CrÃ©er les controllers + routes (`/onboarding/*`, `/import/*`)
- [x] 8. Tester les endpoints avec curl (preview + import : 5/5 lignes importÃ©es, 0 erreurs)

### Phase 2 : Frontend Onboarding (PrioritÃ© haute) âœ… TERMINÃ‰ (2026-02-17)
- [x] 9. CrÃ©er la page `/onboarding` avec wizard multi-Ã©tapes (3 steps : Business â†’ Import â†’ RÃ©sultat)
- [x] 10. Step 1 : Formulaire Business Info (nom, devise, secteur)
- [x] 11. Step 2 : Wizard CSV (upload, preview, mapping, import) â€” mode dÃ©mo retirÃ©
- [x] 12. Step 2 : Upload CSV + Preview tableau
- [x] 13. Step 2 : Affichage mapping suggÃ©rÃ© + Ã©dition manuelle
- [x] 14. Step 2 : Validation + lancement import
- [x] 15. Step 3 : Page rÃ©sultat (compteurs + erreurs + bouton dashboard)
- [x] 16. Redirect automatique vers `/onboarding` si nouvel utilisateur (RequireAuth)

### Phase 3 : Pages Read-Only (PrioritÃ© moyenne) âœ… TERMINÃ‰ (2026-02-21)
- [x] 17. Page Clients : table + page dÃ©tail client avec historique transactions
- [x] 18. Page Transactions : table + filtres (date, type, catÃ©gorie) + totaux income/expense/net
- [x] 19. Page Engagements : liste + badges de statut
- [x] 20. Page Reports : historique QueryLog + rapports gÃ©nÃ©rÃ©s
- [x] 21. Page Settings : infos business + bouton "Re-import CSV"

### Phase 4 : Polish (PrioritÃ© basse)
- [ ] 22. Gestion d'erreurs globale (toasts, messages d'erreur)
- [ ] 23. Loading states et skeleton screens
- [ ] 24. Responsive design vÃ©rification
- [ ] 25. Test end-to-end du flow complet (signup â†’ onboarding â†’ import â†’ dashboard)

---

## ğŸ¯ Prochaines Actions Prioritaires (MVP Data-first)

### ~~Session 2026-02-17~~ âœ… FAIT
1. ~~**ğŸ—ƒï¸ ModÃ¨les Prisma**~~ âœ…
2. ~~**ğŸ“¦ Backend Import**~~ âœ…
3. ~~**ğŸ”Œ Endpoints**~~ âœ…
4. ~~**ğŸ§ª Tests manuels**~~ âœ…

### ~~Session 2026-02-17 (Frontend Onboarding)~~ âœ… FAIT

### Session 2026-02-19 â€” Pages Read-Only (en cours)
> ğŸ“ Mode guidÃ© : Claude explique quoi faire, pourquoi et comment. L'Ã©tudiant code.

- [x] 1. Setup `router.tsx` â€” brancher toutes les nouvelles routes
- [x] 2. Setup `Sidebar.tsx` â€” remplacer "Businesses" par "Transactions"
- [x] 3. Hook `useTransactions.ts` â€” fetch GET /transactions (`response.data.items` âš ï¸)
- [x] 4. Page `TransactionsPage.tsx` â€” cards rÃ©sumÃ© + filtre + table âœ… FONCTIONNEL
- [ ] 5. Hook `useClients.ts` â€” fetch GET /clients
- [ ] 6. Page `ClientPage.tsx` â€” table cliquable
- [ ] 7. Hook `useClientDetail.ts` â€” fetch GET /clients/:id + ses transactions + ses engagements
- [ ] 8. Page `ClientDetailPage.tsx` â€” infos + engagements + transactions du client
- [ ] 9. Hook `useEngagements.ts` â€” fetch GET /engagements
- [ ] 10. Page `EngagementPage.tsx` â€” table cliquable
- [ ] 11. Hook `useEngagementDetail.ts` â€” fetch GET /engagements/:id + ses items + ses transactions
- [ ] 12. Page `EngagementDetailPage.tsx` â€” items + transactions liÃ©es
- [ ] 13. Page `ReportsPage.tsx` â€” query logs + rapports IA
- [ ] 14. Page `SettingsPage.tsx` â€” infos business + bouton re-import

### âš ï¸ LeÃ§on apprise (2026-02-19)
Le backend enveloppe ses rÃ©ponses dans un objet â€” toujours vÃ©rifier le controller avant d'Ã©crire le hook :
- `GET /transactions` â†’ retourne `{ items: [...] }` â†’ utiliser `response.data.items`
- VÃ©rifier le pattern pour chaque endpoint avant de coder le hook correspondant

---

## ğŸ“š Notes PÃ©dagogiques â€” Comprendre ce qu'on construit

> Cette section explique les concepts clÃ©s utilisÃ©s dans le projet.
> Ã€ lire pour comprendre les dÃ©cisions d'architecture.

---

### ğŸ”„ Le pattern qu'on rÃ©pÃ¨te sur chaque page

Chaque page read-only suit **toujours le mÃªme schÃ©ma** en 3 couches :

```
Hook (useXxx.ts)         â†’ fetch les donnÃ©es depuis l'API backend
Page (XxxPage.tsx)       â†’ affiche les donnÃ©es, gÃ¨re loading/erreur
Composant UI (Card, Badge) â†’ mise en forme visuelle
```

**Pourquoi sÃ©parer le hook de la page ?**
Le hook s'occupe de la logique (appel API, Ã©tat loading, erreurs).
La page s'occupe uniquement de l'affichage.
â†’ Plus facile Ã  relire, tester, et rÃ©utiliser.

---

### ğŸ›£ï¸ Comment fonctionne le routing (React Router)

```
router.tsx dÃ©finit les URLs de l'application :

/dashboard                â†’ DashboardPage
/dashboard/transactions   â†’ TransactionsPage
/dashboard/clients        â†’ ClientsPage
/dashboard/clients/:id    â†’ ClientDetailPage   â† :id = variable dans l'URL
/dashboard/engagements    â†’ EngagementsPage
/dashboard/engagements/:id â†’ EngagementDetailPage
/dashboard/reports        â†’ ReportsPage
/dashboard/settings       â†’ SettingsPage
```

**Qu'est-ce que `:id` ?**
C'est un paramÃ¨tre dynamique dans l'URL.
Ex: `/dashboard/clients/42` â†’ `:id` = 42
Dans le composant, on rÃ©cupÃ¨re Ã§a avec `useParams()` de React Router.

```tsx
const { id } = useParams(); // id = "42"
```

---

### ğŸª Ce qu'est un Hook React (useXxx)

Un hook est une **fonction rÃ©utilisable** qui encapsule de la logique React.

```ts
// Exemple : useClients.ts
export function useClients(businessId) {
  const [clients, setClients] = useState([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    // fetch les clients depuis l'API quand businessId change
    api.get(`/clients?business_id=${businessId}`)
      .then(res => setClients(res.data));
  }, [businessId]);

  return { clients, loading };
}

// Dans la page :
const { clients, loading } = useClients(selectedBusinessId);
```

**Pourquoi `useEffect` ?**
`useEffect` s'exÃ©cute aprÃ¨s le rendu.
Le tableau `[businessId]` = "relance l'effet si businessId change".

---

### ğŸ—ï¸ DiffÃ©rence Engagement vs Transaction (rappel)

| Concept | Analogie boutique Michael | Dans le code |
|---------|--------------------------|--------------|
| **Engagement** | Une commande client (contrat) | `Engagement` avec statut draft/active/completed |
| **EngagementItem** | Les produits dans la commande | `EngagementItem` avec qty Ã— prix |
| **Transaction** | L'argent reÃ§u/payÃ© rÃ©ellement | `Transaction` income/expense |

Un engagement = la **promesse**. Une transaction = l'**argent qui bouge**.

---

### ğŸ¨ Composants UI rÃ©utilisÃ©s

```tsx
<Card className="p-6">          // conteneur arrondi avec fond semi-transparent
<Badge className="...">         // petit label colorÃ© (statut, type)
```

Pour les couleurs de badge selon le contexte :
- `income` â†’ vert  (`text-emerald-300 bg-emerald-500/10`)
- `expense` â†’ rouge (`text-red-300 bg-red-500/10`)
- `active`  â†’ bleu  (`text-blue-300 bg-blue-500/10`)
- `draft`   â†’ gris  (`text-white/50 bg-white/5`)
- `completed` â†’ vert (`text-emerald-300 bg-emerald-500/10`)
- `cancelled` â†’ rouge (`text-red-300 bg-red-500/10`)

---

## ğŸ“Š MÃ©triques de Progression MVP

| CatÃ©gorie | Backend | Frontend | Statut MVP |
|-----------|---------|----------|------------|
| **Authentification** | 100% âœ… | 100% âœ… | âœ… COMPLET |
| **Gestion Business** | 100% âœ… | 100% âœ… | âœ… COMPLET |
| **Dashboard** | 100% âœ… | 100% âœ… | âœ… COMPLET |
| **IA Assistant** | 100% âœ… | 100% âœ… | âœ… COMPLET |
| **Onboarding** | 100% âœ… | 100% âœ… | âœ… COMPLET |
| **Import CSV Intelligent** | 100% âœ… | 100% âœ… | âœ… COMPLET |
| **Page Clients (read-only)** | 100% âœ… | 0% âŒ | âŒ Frontend manquant |
| **Page Transactions (read-only)** | 100% âœ… | 0% âŒ | âŒ Frontend manquant |
| **Page Engagements (read-only)** | 100% âœ… | 0% âŒ | âŒ Frontend manquant |
| **Page Reports (read-only)** | 100% âœ… | 0% âŒ | âŒ Frontend manquant |
| **Page Settings** | 100% âœ… | 0% âŒ | âŒ Frontend manquant |

### LÃ©gende
- âœ… **COMPLET** : PrÃªt pour MVP
- âš ï¸ **PARTIEL** : Utilisable mais amÃ©liorable
- âŒ **MANQUANT** : Ã€ faire pour MVP complet

---

## ğŸ”§ Configuration Requise

### Variables d'environnement Backend (.env)
```env
DATABASE_URL=postgresql://...
JWT_SECRET=...
PORT=3000
OPENAI_API_KEY=...
KAIROS_EXTRACTOR_KEY=kairos_dev_secret
KAIROS_EXTRACTOR_URL=http://localhost:8001
```

### Variables d'environnement Frontend (.env)
```env
VITE_API_BASE_URL=http://localhost:3000
```

### Commandes de dÃ©marrage
```bash
# Backend
cd Kairos-backend
npm run dev

# Frontend
cd kairos-frontend
npm run dev

# Service Python (optionnel)
cd Kairos-backend/python-extractor
uvicorn app.main:app --reload --port 8001
```

---

## ğŸ“ Notes Importantes

### Conventions de Code
- **TypeScript strict mode** activÃ©
- **Nomenclature :**
  - Fichiers : camelCase pour les fichiers TS/JS, PascalCase pour les composants React
  - Variables : camelCase
  - Types : PascalCase
  - Constantes : UPPER_SNAKE_CASE
- **Architecture :** Toujours suivre le pattern Routes â†’ Controllers â†’ Services
- **SÃ©curitÃ© :** Toujours utiliser `requireAuth` + `requireBusinessAccess` pour les endpoints sensibles

### Bugs Connus

#### Bug 1 : IA ne voit pas les noms de clients aprÃ¨s import CSV
- **SymptÃ´me :** La query "Top 5 clients by growth" rÃ©pond "les noms des clients ne sont pas disponibles"
- **Cause probable :** Le SQL gÃ©nÃ©rÃ© fait `JOIN public.clients` mais les transactions importÃ©es stockent `client_name` comme string dans la table `transactions`, sans crÃ©er de vrais enregistrements dans la table `clients`
- **Ã€ investiguer :** VÃ©rifier si `importService.ts` crÃ©e bien des clients dans la table `clients` lors de l'import, et si le SQL gÃ©nÃ©rÃ© par l'IA cible la bonne colonne (`transactions.client_name` vs `clients.first_name + last_name`)

#### Bug 2 : Graphiques ne s'affichent pas aprÃ¨s import CSV
- **SymptÃ´me :** RevenueLineChart et ExpensePieChart vides aprÃ¨s import des donnÃ©es
- **Ã€ investiguer :** VÃ©rifier si les endpoints `/dashboard/monthly-trend` et `/dashboard/expenses-by-category` retournent des donnÃ©es non-vides aprÃ¨s import, et si le format de date/montant des donnÃ©es importÃ©es correspond Ã  ce qu'attendent les requÃªtes dashboard

#### CSV de test (tech/SaaS, Jan-Mar 2025, QuÃ©bec)
```
date,type,amount,category,client_name,description,payment_method
2025-01-01,expense,7754.0,Taxes,,Frais de consultation juridique,transfer
2025-01-01,income,849.0,Abonnements,Ville de Laval,IntÃ©gration API + formation,transfer
...clients: Ville de Laval, Ã‰coTrans Logistique, Manufacture Atlas, Assurance BorÃ©ale, Studio Pixel&Co, Groupe Immobilier Horizon, UniversitÃ© du QuÃ©bec, Clinique Nova SantÃ©, Startup MÃ©tÃ©ore, Cabinet Lavoie & AssociÃ©s, Nordik Finance Inc.
```

### AmÃ©liorations Techniques Future

#### IA & Intelligence
- [ ] **AmÃ©liorer la dÃ©tection d'intent pour "analyse mes revenues"** : Quand l'utilisateur demande une analyse, automatiquement aller chercher AUSSI les dÃ©penses pour fournir une analyse complÃ¨te (revenus + dÃ©penses + net) au lieu de juste les revenus. Actuellement, l'utilisateur doit explicitement demander "analyse financiÃ¨re complÃ¨te" pour obtenir les deux.
- [ ] Ajouter support pour les graphiques gÃ©nÃ©rÃ©s par l'IA
- [ ] Historique des questions posÃ©es Ã  l'IA (accessible via UI)

#### Infrastructure & Tests
- [ ] Migration vers React Query pour le state management serveur
- [ ] Ajout de tests unitaires (Jest + React Testing Library)
- [ ] Ajout de tests E2E (Playwright)
- [ ] Dockerisation complÃ¨te
- [ ] CI/CD avec GitHub Actions
- [ ] Monitoring et logging (Sentry)

---

## ğŸ“š Ressources

- [Documentation Prisma](https://www.prisma.io/docs)
- [Documentation React Router](https://reactrouter.com/)
- [Documentation TailwindCSS](https://tailwindcss.com/docs)
- [API OpenAI](https://platform.openai.com/docs)

---

## ğŸ¯ Objectif MVP Final

**Pour la prÃ©sentation scolaire, on doit avoir :**
1. âœ… Dashboard fonctionnel avec vraies donnÃ©es
2. âœ… **Graphiques de visualisation** âœ… TERMINÃ‰ (2026-02-15)
3. âœ… **Assistant IA Kairos fonctionnel** âœ… TERMINÃ‰ (2026-02-06)
4. âœ… Upload et analyse de documents
5. âœ… Gestion des clients et business
6. âœ… **Onboarding + Import CSV Intelligent** âœ… TERMINÃ‰ (2026-02-17)
7. âŒ **Pages read-only** : Clients, Transactions, Engagements, Reports, Settings (Ã€ FAIRE)

---

**ğŸ¯ Session 2026-02-15 : Dashboard Graphiques - SUCCÃˆS âœ…**
- âœ… DonnÃ©es de test ajoutÃ©es (20 transactions seed : 10 income + 10 expense)
- âœ… 2 nouveaux endpoints backend : `monthly-trend` + `expenses-by-category`
- âœ… Hook `useDashboard()` mis Ã  jour (5 appels API en parallÃ¨le)
- âœ… Composant `RevenueLineChart` : Line chart revenu vs dÃ©penses sur 6 mois
- âœ… Composant `ExpensePieChart` : Donut chart dÃ©penses par catÃ©gorie
- âœ… IntÃ©gration dans DashboardPage avec loading states
- âœ… Recharts installÃ© et configurÃ©

**ğŸ¯ Session 2026-02-17 : Pivot MVP Data-first + Backend Import - SUCCÃˆS âœ…**
- Nouveau scope : Import CSV Intelligent assistÃ© par IA
- Pages read-only (pas de CRUD complet)
- Abandon du dÃ©ploiement Vercel pour l'instant
- Phase 1 Backend complÃ©tÃ©e :
  - âœ… ModÃ¨les Prisma `ImportJob` + `ImportRowError` + migration
  - âœ… `csvParserService.ts` : parsing CSV + preview
  - âœ… `columnMappingService.ts` : heuristique + appel IA OpenAI
  - âœ… `importService.ts` + `importHelpers.ts` : normalisation + validation + insertion
  - âœ… Controllers + Routes (`/onboarding/*`, `/import/*`)
  - âœ… Tests curl : preview OK, import 5/5 lignes, 0 erreurs

**ğŸ¯ Session 2026-02-17 : Frontend Onboarding - SUCCÃˆS âœ…**
- âœ… Wizard 3 Ã©tapes : Business â†’ CSV Import â†’ RÃ©sultat
- âœ… `BusinessInfoStep.tsx` : formulaire business + appel `/onboarding/business`
- âœ… `CsvWizardStep.tsx` : upload + preview + mapping IA + import
- âœ… `ImportResultStep.tsx` : compteurs + erreurs + redirect dashboard
- âœ… `OnboardingPage.tsx` : wizard parent avec progress bar 3 steps
- âœ… `RequireAuth.tsx` : redirect auto vers `/onboarding` si 0 businesses
- âœ… Mode dÃ©mo retirÃ©, texte blanc (text-white sur wrapper)
- âœ… Bugs backend corrigÃ©s : `user_id` (pas `id_user`), `mappings` (pluriel), clÃ© `preview`

**ğŸ¯ Session 2026-02-21 â€” Pages Read-Only - SUCCÃˆS âœ…**
- âœ… `useClients` + `ClientPage` + `useClientDetail` + `ClientDetailPage`
- âœ… `useEngagements` + `EngagementPage` + `useEngagementsDetails` + `EngagementDetailPage`
- âœ… `useReports` + `ReportsPage`
- âœ… `SettingsPage` + re-import CSV (saute le step Business via router state)
- âœ… Convention Ã©tablie : tous les GET API dans des hooks (useXxx)

**ğŸ¯ Prochaine session**
1. **ğŸ”˜ Bouton Logout** : ajouter un bouton de dÃ©connexion visible dans la sidebar ou le header
2. **ğŸ› Corriger Bug graphiques** : vÃ©rifier pourquoi les charts sont vides aprÃ¨s import CSV (endpoints `/dashboard/monthly-trend` et `/dashboard/expenses-by-category`)
3. **ğŸ› Corriger Bug IA clients** : vÃ©rifier pourquoi "Top 5 clients by growth" ne trouve pas les noms (`transactions.client_name` vs table `clients`)
4. **ğŸ¨ Phase 4 Polish** (optionnel) : toasts d'erreur, skeleton screens, test E2E

_DerniÃ¨re mise Ã  jour PLAN.MD : 2026-02-21 - Phase 3 Pages Read-Only terminÃ©e_
