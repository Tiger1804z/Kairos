# üìã PLAN.MD - Projet Kairos

**Derni√®re mise √† jour :** 2026-02-22
**Progression globale :** 85%
**Type de projet :** Projet scolaire (MVP pour pr√©sentation)
**Focus actuel :** üì¶ **MVP Data-first** - Onboarding & Import CSV Intelligent assist√© par IA

---

## üéØ Vue d'ensemble du projet

**Kairos** est une plateforme MVP de gestion d'entreprise avec intelligence artificielle qui permet aux propri√©taires de PME de :
- Importer leurs donn√©es financi√®res via un CSV intelligent assist√© par IA
- Visualiser leurs clients, transactions et engagements (lecture seule)
- Analyser leurs documents financiers automatiquement (OpenAI)
- Obtenir des insights via un assistant IA
- Visualiser leurs donn√©es via un dashboard interactif

**üéì Objectif scolaire :** Pr√©senter un MVP fonctionnel avec import de donn√©es intelligent et pages read-only

**üìå Nouveau scope MVP :** Les pages (Clients, Transactions, Engagements, Reports, Settings) sont **read-only** : elles affichent les items et leurs d√©tails, mais pas de CRUD complet. Le seul "create" c√¥t√© produit est l'**onboarding + import CSV intelligent**.

---

## üèóÔ∏è Architecture Technique

### Backend (Node.js + TypeScript)
- **Framework :** Express.js
- **Base de donn√©es :** PostgreSQL via Prisma ORM
- **Authentification :** JWT avec middleware `requireAuth`
- **S√©curit√© :** Business scoping avec `requireBusinessAccess`
- **Structure :** Architecture 3-couches (Routes ‚Üí Controllers ‚Üí Services)

### Frontend (React + TypeScript)
- **Framework :** React 18 + React Router
- **Styling :** TailwindCSS
- **State Management :** Context API (AuthContext, BusinessContext)
- **API Client :** Axios avec intercepteurs JWT

### Service Python (FastAPI)
- **Extraction de documents :** PDF, CSV, TXT
- **Communication :** HTTP avec le backend Node.js
- **Stockage :** Fichiers locaux structur√©s

---

## ‚úÖ Fonctionnalit√©s Impl√©ment√©es (85% backend)

### üîê Authentification & Autorisation
- [x] Inscription utilisateur (signup)
- [x] Connexion (login)
- [x] Middleware JWT (`requireAuth`)
- [x] Protection des routes frontend (`RequireAuth`)
- [x] Context d'authentification (`AuthContext`)
- [x] Redirection vers login si non authentifi√©

### üë§ Gestion des Utilisateurs
- [x] Endpoint GET `/auth/me` - R√©cup√©rer l'utilisateur connect√©
- [x] Syst√®me de r√¥les (owner, admin, employee)
- [x] Page de profil basique

### üè¢ Gestion des Businesses
- [x] CRUD businesses complet
- [x] Middleware `requireBusinessAccess` (v√©rification ownership)
- [x] Context global `BusinessContext`
- [x] S√©lecteur de business dans le header
- [x] Persistance du business s√©lectionn√© (localStorage)

### üë• Gestion des Clients
- [x] CRUD clients complet
- [x] Filtrage par business
- [x] Page liste des clients
- [x] Validation email unique par business

### üìÑ Gestion des Documents
- [x] Upload de documents (multer)
- [x] Stockage structur√© par business/date
- [x] Extraction de contenu via service Python
- [x] Analyse IA (finance ou g√©n√©ral)
- [x] Persistance m√©tadonn√©es (Prisma)

### üí∞ Gestion des Transactions
- [x] CRUD transactions
- [x] Types : income/expense
- [x] M√©thodes de paiement
- [x] Cat√©gorisation
- [x] Liaison avec clients/engagements

### üìä Gestion des Engagements
- [x] CRUD engagements
- [x] Statuts (draft, active, completed, cancelled)
- [x] Items d'engagement (products, services, hourly, subscription)
- [x] Calcul des totaux

### üìà Dashboard (COMPLET ‚úÖ)
- [x] **Backend :**
  - [x] Service `dashboardService.ts` avec 5 fonctions
  - [x] Controller `dashboardController.ts`
  - [x] Routes `dashboardRoutes.ts` prot√©g√©es
  - [x] Endpoint GET `/dashboard/metrics` (clients, engagements, revenu)
  - [x] Endpoint GET `/dashboard/top-clients` (top 5 par revenu)
  - [x] Endpoint GET `/dashboard/revenue-growth` (croissance mois par mois)
  - [x] Endpoint GET `/dashboard/monthly-trend` (revenu + d√©penses sur 6 mois)
  - [x] Endpoint GET `/dashboard/expenses-by-category` (d√©penses par cat√©gorie)
- [x] **Frontend :**
  - [x] Hook `useDashboard()` pour fetch les donn√©es (5 endpoints en parall√®le)
  - [x] Page `DashboardPage.tsx` avec vraies donn√©es API
  - [x] Composant `BusinessSelector` dans le header
  - [x] Affichage m√©triques principales
  - [x] Affichage top clients
  - [x] Affichage croissance du revenu
  - [x] Loading states et error handling
  - [x] Formatage mon√©taire (CAD)
  - [x] **Composant `RevenueLineChart`** - Line chart revenu vs d√©penses (6 mois)
  - [x] **Composant `ExpensePieChart`** - Donut chart d√©penses par cat√©gorie
  - [x] **Librairie Recharts** install√©e et int√©gr√©e

### ü§ñ Intelligence Artificielle (COMPLET ‚úÖ)
- [x] **Backend : Service `aiService.ts` complet avec OpenAI**
- [x] **Endpoint POST `/ai/ask`** - Questions naturelles ‚Üí SQL ‚Üí R√©ponses
- [x] **Endpoint GET `/ai/daily-finance-summary`** - R√©sum√© quotidien
- [x] G√©n√©ration de SQL s√©curis√© (`generateSQLFromQuestion`)
- [x] Validation SQL avec `sqlGuard`
- [x] Analyse de documents financiers (PDF, CSV)
- [x] D√©tection automatique du type de document
- [x] G√©n√©ration de r√©sum√©s avec GPT-4o-mini
- [x] Logging automatique des requ√™tes (`QueryLog`)
- [x] Cr√©ation automatique de rapports (`Report`)
- [x] Support multi-intents (revenus, d√©penses, net, par cat√©gorie)
- [x] **Frontend : Hook `useAskKairos()` cr√©√©**
- [x] **Frontend : `AskKairosInput` connect√© √† l'API**
- [x] **Frontend : Affichage des r√©ponses de l'IA dans le Dashboard**
- [x] **Frontend : Gestion des erreurs et loading states**

### üìä Rapports & Logs
- [x] QueryLogs (historique des requ√™tes IA)
- [x] Rapports g√©n√©r√©s
- [x] Persistance en base de donn√©es

---

## üì¶ Onboarding & Import CSV Intelligent (MVP Data-first)

### üéØ Concept

Le MVP adopte une approche **"Data-first"** : plut√¥t que de proposer un CRUD complet sur chaque entit√©, l'utilisateur importe ses donn√©es existantes via un **import CSV intelligent assist√© par IA**, puis navigue dans ses donn√©es en **lecture seule** via les diff√©rentes pages.

Le seul flux de cr√©ation est l'**onboarding** (cr√©ation du business + import des donn√©es).

### üîÑ Flow UX complet

#### Step 0 : Redirect automatique
- Si l'utilisateur est authentifi√© mais n'a **aucun business** ou **aucune donn√©e**, redirection automatique vers `/onboarding`
- V√©rification c√¥t√© frontend via `BusinessContext`

#### Step 1 : Formulaire Business Info
- **Champs obligatoires :**
  - `name` : Nom de l'entreprise
  - `currency` : Devise (CAD, USD, EUR...)
- **Champs optionnels :**
  - `industry` : Secteur d'activit√© (dropdown)
  - `timezone` : Fuseau horaire (d√©faut : America/Montreal)

#### Step 2 : Choix du mode d'import
- **Option A : Import CSV intelligent** (recommand√©) ‚Üí Step 3
- **Option B : Donn√©es de d√©monstration** (seed) ‚Üí Insertion des donn√©es de test existantes ‚Üí Step 4

#### Step 3 : Wizard d'import CSV
1. **Upload du fichier CSV** : Drag & drop ou s√©lection de fichier
2. **Preview** : Affichage des 10 premi√®res lignes du CSV dans un tableau
3. **D√©tection automatique** : Matching heuristique des colonnes (voir section Import Intelligent)
4. **Suggestion de mapping IA** : Si colonnes ambigu√´s, appel √† OpenAI pour sugg√©rer le mapping
5. **√âdition manuelle du mapping** : L'utilisateur peut corriger/modifier les associations propos√©es
6. **Validation** : V√©rification des donn√©es avant import (types, formats, champs requis)
7. **Import** : Lancement de l'import en backend avec barre de progression

#### Step 4 : R√©sultat de l'import
- Nombre de lignes import√©es avec succ√®s
- Nombre de lignes ignor√©es (doublons, donn√©es invalides)
- Erreurs d√©taill√©es (num√©ro de ligne + message d'erreur)
- Bouton **"Aller au Dashboard"** pour acc√©der √† l'application

---

### üìÑ Format CSV MVP

#### Colonnes minimum requises

| Colonne | Type | Description |
|---------|------|-------------|
| `date` | string | Date de la transaction (formats accept√©s ci-dessous) |
| `type` | string | Type : `income`, `expense` (ou synonymes d√©tect√©s automatiquement) |
| `amount` | number | Montant (positif) |

#### Colonnes optionnelles

| Colonne | Type | Description |
|---------|------|-------------|
| `category` | string | Cat√©gorie (ex: "Marketing", "Salaire", "Vente") |
| `client_name` | string | Nom du client associ√© |
| `description` | string | Description / libell√© |
| `payment_method` | string | M√©thode de paiement (cash, card, transfer, other) |
| `reference_number` | string | Num√©ro de r√©f√©rence / facture |

#### Formats de date accept√©s
- `YYYY-MM-DD` (ISO 8601)
- `DD/MM/YYYY`
- `MM/DD/YYYY`
- `YYYY/MM/DD`

---

### üß† Syst√®me d'Import Intelligent

#### √âtape 1 : D√©tection automatique des colonnes (heuristique)

Matching bas√© sur lowercase + trim + synonymes connus :

| Header CSV d√©tect√© | Mapping Kairos |
|-------------------|----------------|
| `date`, `transaction_date`, `trans_date` | `date` |
| `revenue`, `income`, `revenu`, `entr√©e` | `type: income` |
| `cost`, `expense`, `d√©pense`, `sortie` | `type: expense` |
| `amount`, `montant`, `total`, `sum` | `amount` |
| `category`, `cat√©gorie`, `cat` | `category` |
| `client`, `client_name`, `customer`, `nom_client` | `client_name` |
| `description`, `desc`, `libell√©`, `label`, `memo` | `description` |
| `payment`, `payment_method`, `mode_paiement` | `payment_method` |
| `reference`, `ref`, `reference_number`, `invoice` | `reference_number` |

#### √âtape 2 : Appel IA pour colonnes ambigu√´s

Si certaines colonnes du CSV ne sont pas reconnues par l'heuristique :
- **Envoi √† OpenAI** : uniquement les **headers + 5 premi√®res lignes** du CSV (jamais la base compl√®te)
- **Prompt structur√©** : demander √† l'IA de retourner un mapping JSON `{ csvColumn ‚Üí kairosField }`
- **Validation backend** : le mapping sugg√©r√© par l'IA est **valid√© c√¥t√© backend** avant toute application
- L'IA ne touche **jamais** directement √† la base de donn√©es

#### √âtape 3 : Normalisation en TypeScript (backend Node.js)

Toute la normalisation est faite c√¥t√© backend, jamais par l'IA :

1. **Parsing des dates** : D√©tection du format parmi les formats accept√©s, conversion en `Date` ISO
2. **Parsing des montants** : Gestion des virgules (`1 234,56` ‚Üí `1234.56`), points, espaces
3. **Mapping du type** : Normalisation vers l'enum `income` / `expense` (synonymes support√©s)
4. **Normalisation des cat√©gories** : lowercase, trim, fallback vers `"other"` si vide ou inconnu
5. **Cr√©ation automatique des clients** : Si `client_name` fourni et client inexistant dans le business ‚Üí cr√©ation automatique (d√©duplication case-insensitive)
6. **Scoping business** : Toutes les insertions incluent le `business_id` de l'utilisateur
7. **D√©duplication** : V√©rification case-insensitive pour √©viter les doublons (m√™me date + m√™me montant + m√™me description = doublon potentiel ‚Üí marqu√© comme skipped)

---

### üîå Endpoints Backend

#### Onboarding

| M√©thode | Route | Description |
|---------|-------|-------------|
| `POST` | `/onboarding/business` | Cr√©ation du business pendant l'onboarding (name, currency, industry?, timezone?) |

#### Import CSV

| M√©thode | Route | Description |
|---------|-------|-------------|
| `POST` | `/import/transactions/preview` | Upload CSV + retourne preview (10 lignes) + mapping sugg√©r√© (heuristique + IA si n√©cessaire) |
| `POST` | `/import/transactions` | Lancement de l'import avec le mapping valid√© par l'utilisateur |
| `GET` | `/import/jobs` | Liste des jobs d'import pour le business courant |
| `GET` | `/import/jobs/:id` | D√©tail d'un job d'import (statut, compteurs, erreurs) |

Tous les endpoints sont prot√©g√©s par `requireAuth` + `requireBusinessAccess`.

---

### üóÉÔ∏è Nouveaux Mod√®les Prisma

```prisma
model ImportJob {
  id             String           @id @default(uuid())
  business_id    String
  business       Business         @relation(fields: [business_id], references: [id])
  filename       String
  status         ImportJobStatus  @default(PENDING)
  inserted_count Int              @default(0)
  skipped_count  Int              @default(0)
  error_count    Int              @default(0)
  created_at     DateTime         @default(now())
  errors         ImportRowError[]
}

model ImportRowError {
  id           String    @id @default(uuid())
  job_id       String
  job          ImportJob @relation(fields: [job_id], references: [id])
  row_number   Int
  message      String
  raw_row_json Json
}

enum ImportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
```

---

### üì± Mise √† jour des Pages (Read-Only)

Les pages passent en mode **lecture seule** : affichage des donn√©es import√©es, pas de formulaires de cr√©ation/√©dition.

| Page | Route | Contenu |
|------|-------|---------|
| **Clients** | `/dashboard/clients` | Table des clients + page d√©tail client (historique transactions associ√©es) |
| **Transactions** | `/dashboard/transactions` | Table des transactions + filtres (date, type, cat√©gorie) + totaux income/expense/net |
| **Engagements** | `/dashboard/engagements` | Liste des engagements + badges de statut (draft, active, completed, cancelled) |
| **Reports** | `/dashboard/reports` | Historique des QueryLogs + rapports g√©n√©r√©s par l'IA |
| **Settings** | `/dashboard/settings` | Infos business (read-only) + actions : "Re-import CSV" + "R√©initialiser donn√©es d√©mo" |

---

### üîí S√©curit√© & Isolation

1. **L'IA ne re√ßoit jamais la base compl√®te** : seuls les headers + un √©chantillon de 5 lignes du CSV sont envoy√©s √† OpenAI
2. **L'IA ne touche jamais la base de donn√©es** : elle retourne un mapping JSON, le backend valide et applique
3. **Validation stricte c√¥t√© backend** : tous les champs sont valid√©s (types, formats, longueurs) avant insertion
4. **Scoping par `business_id`** : toutes les donn√©es sont isol√©es par business, aucun acc√®s crois√© possible
5. **Middleware `requireBusinessAccess`** : v√©rifie que l'utilisateur a acc√®s au business cibl√© sur chaque endpoint
6. **Pas de donn√©es sensibles envoy√©es √† l'IA** : aucun montant r√©el, aucune info client n'est envoy√©e lors du mapping

---

## üöß En Cours de D√©veloppement

**Phase 2 : Frontend Onboarding (wizard multi-√©tapes + import CSV)**

---

## üìù Fonctionnalit√©s √† Impl√©menter - MVP Data-first

### üéØ PRIORIT√â MVP - √Ä FAIRE

#### 1. ü§ñ ~~Connecter l'Assistant IA~~ ‚úÖ TERMIN√â (2026-02-06)
- [x] **Frontend uniquement - Backend d√©j√† fait ‚úÖ**
  - [x] Hook `useAskKairos()` pour appeler POST `/ai/ask`
  - [x] Connecter `AskKairosInput` au backend
  - [x] Afficher les r√©ponses de l'IA dans une Card
  - [x] Loading state pendant la g√©n√©ration
  - [x] Afficher le SQL g√©n√©r√© (optionnel)
  - [x] Gestion d'erreurs (unsafe SQL, erreur serveur)

#### 2. üìä ~~Dashboard - Graphiques~~ ‚úÖ TERMIN√â (2026-02-15)
- [x] Installer Recharts
- [x] Graphique de croissance du revenu (line chart) - 6 mois
- [x] Graphique r√©partition d√©penses par cat√©gorie (donut chart)
- [x] Responsive via ResponsiveContainer
- [x] Donn√©es de test ajout√©es (20 transactions seed)

#### 3. üì¶ Onboarding & Import CSV Intelligent (√Ä FAIRE)
- [ ] Step 0 : Redirect vers `/onboarding` si aucun business/donn√©es
- [ ] Step 1 : Formulaire Business Info
- [ ] Step 2 : Choix du mode (CSV / Demo data)
- [ ] Step 3 : Wizard d'import CSV complet
- [ ] Step 4 : Page r√©sultat d'import

#### 4. üìñ Pages Read-Only (√Ä FAIRE)
- [ ] Page Clients (table + d√©tail)
- [ ] Page Transactions (table + filtres + totaux)
- [ ] Page Engagements (list + badges statut)
- [ ] Page Reports (historique QueryLog + rapports)
- [ ] Page Settings (infos business + actions re-import)

### üîÆ HORS SCOPE MVP - Pour release future
_Ces fonctionnalit√©s ne sont PAS n√©cessaires pour la pr√©sentation scolaire_

<details>
<summary>Fonctionnalit√©s post-MVP (cliquer pour voir)</summary>

#### CRUD complet
- [ ] Formulaires de cr√©ation/√©dition clients
- [ ] Formulaires de cr√©ation/√©dition transactions
- [ ] Formulaires de cr√©ation/√©dition engagements

#### Documents
- [ ] Preview et t√©l√©chargement
- [ ] Recherche full-text

#### Transactions
- [ ] R√©conciliation bancaire

#### Engagements
- [ ] G√©n√©ration de factures PDF
- [ ] Envoi par email

#### Rapports
- [ ] G√©n√©rateur personnalis√©
- [ ] Export multi-formats

#### Param√®tres
- [ ] Changement de mot de passe

#### Notifications
- [ ] Syst√®me temps r√©el
- [ ] Email notifications

#### Multi-utilisateurs
- [ ] Invitation d'√©quipe
- [ ] Gestion permissions avanc√©e

#### D√©ploiement
- [ ] D√©ploiement Vercel (hors scope pour l'instant)
</details>

---

## üóÇÔ∏è Structure des Fichiers

### Backend (`Kairos-backend/`)
```
src/
‚îú‚îÄ‚îÄ controllers/     # Logique HTTP (req/res)
‚îÇ   ‚îú‚îÄ‚îÄ authController.ts
‚îÇ   ‚îú‚îÄ‚îÄ dashboardController.ts
‚îÇ   ‚îú‚îÄ‚îÄ clientController.ts
‚îÇ   ‚îú‚îÄ‚îÄ onboardingController.ts    ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ importController.ts        ‚Üê NOUVEAU
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ services/       # Logique m√©tier + DB
‚îÇ   ‚îú‚îÄ‚îÄ authService.ts
‚îÇ   ‚îú‚îÄ‚îÄ dashboardService.ts
‚îÇ   ‚îú‚îÄ‚îÄ clientsService.ts
‚îÇ   ‚îú‚îÄ‚îÄ onboardingService.ts       ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ importService.ts           ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ csvParserService.ts        ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ columnMappingService.ts    ‚Üê NOUVEAU
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ routes/         # D√©finition des endpoints
‚îÇ   ‚îú‚îÄ‚îÄ authRoutes.ts
‚îÇ   ‚îú‚îÄ‚îÄ dashboardRoutes.ts
‚îÇ   ‚îú‚îÄ‚îÄ clientRoutes.ts
‚îÇ   ‚îú‚îÄ‚îÄ onboardingRoutes.ts        ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ importRoutes.ts            ‚Üê NOUVEAU
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ middleware/     # Middlewares Express
‚îÇ   ‚îú‚îÄ‚îÄ authMiddleware.ts
‚îÇ   ‚îî‚îÄ‚îÄ requireBusinessAccess.ts
‚îú‚îÄ‚îÄ prisma/         # Client Prisma
‚îî‚îÄ‚îÄ index.ts        # Point d'entr√©e
```

### Frontend (`kairos-frontend/`)
```
src/
‚îú‚îÄ‚îÄ pages/          # Pages React
‚îÇ   ‚îú‚îÄ‚îÄ auth/       # Login/Signup
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/  # Dashboard principal
‚îÇ   ‚îú‚îÄ‚îÄ onboarding/ # Wizard onboarding + import     ‚Üê NOUVEAU
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OnboardingPage.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BusinessInfoStep.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ImportModeStep.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CsvWizardStep.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ImportResultStep.tsx
‚îÇ   ‚îú‚îÄ‚îÄ clients/    # Page clients read-only          ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ transactions/ # Page transactions read-only   ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ engagements/  # Page engagements read-only    ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ reports/    # Page reports read-only           ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ settings/   # Page settings                    ‚Üê NOUVEAU
‚îÇ   ‚îî‚îÄ‚îÄ landing/    # Page d'accueil
‚îú‚îÄ‚îÄ components/     # Composants r√©utilisables
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/  # BusinessSelector, RevenueLineChart, ExpensePieChart
‚îÇ   ‚îú‚îÄ‚îÄ import/     # CsvUploader, ColumnMapper, PreviewTable  ‚Üê NOUVEAU
‚îÇ   ‚îú‚îÄ‚îÄ layout/     # Layout (Sidebar, Header)
‚îÇ   ‚îú‚îÄ‚îÄ ui/         # Composants UI de base
‚îÇ   ‚îî‚îÄ‚îÄ kairos/     # AskKairosInput
‚îú‚îÄ‚îÄ hooks/          # Custom hooks
‚îÇ   ‚îú‚îÄ‚îÄ useDashboard.ts
‚îÇ   ‚îî‚îÄ‚îÄ useImport.ts   ‚Üê NOUVEAU
‚îú‚îÄ‚îÄ business/       # BusinessContext
‚îÇ   ‚îî‚îÄ‚îÄ BusinessContext.tsx
‚îú‚îÄ‚îÄ auth/           # AuthContext
‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.tsx
‚îú‚îÄ‚îÄ lib/            # Utils
‚îÇ   ‚îú‚îÄ‚îÄ api.ts      # Client Axios
‚îÇ   ‚îî‚îÄ‚îÄ constants.ts
‚îî‚îÄ‚îÄ app/            # Config app
    ‚îú‚îÄ‚îÄ App.tsx
    ‚îú‚îÄ‚îÄ router.tsx
    ‚îî‚îÄ‚îÄ providers.tsx
```

---

## ‚úÖ Checklist MVP Data-first ‚Äì Import Intelligent

### Phase 1 : Backend Import (Priorit√© haute) ‚úÖ TERMIN√â (2026-02-17)
- [x] 1. Cr√©er les mod√®les Prisma `ImportJob` + `ImportRowError` + migration
- [x] 2. Cr√©er `csvParserService.ts` : parsing CSV + preview 10 lignes
- [x] 3. Cr√©er `columnMappingService.ts` : heuristique de matching des colonnes
- [x] 4. Int√©grer l'appel OpenAI pour le mapping IA des colonnes ambigu√´s
- [x] 5. Cr√©er `importService.ts` : normalisation + validation + insertion en base
- [x] 6. `onboardingService.ts` : skip ‚Äî `businessService.ts` fait d√©j√† le job
- [x] 7. Cr√©er les controllers + routes (`/onboarding/*`, `/import/*`)
- [x] 8. Tester les endpoints avec curl (preview + import : 5/5 lignes import√©es, 0 erreurs)

### Phase 2 : Frontend Onboarding (Priorit√© haute) ‚úÖ TERMIN√â (2026-02-17)
- [x] 9. Cr√©er la page `/onboarding` avec wizard multi-√©tapes (3 steps : Business ‚Üí Import ‚Üí R√©sultat)
- [x] 10. Step 1 : Formulaire Business Info (nom, devise, secteur)
- [x] 11. Step 2 : Wizard CSV (upload, preview, mapping, import) ‚Äî mode d√©mo retir√©
- [x] 12. Step 2 : Upload CSV + Preview tableau
- [x] 13. Step 2 : Affichage mapping sugg√©r√© + √©dition manuelle
- [x] 14. Step 2 : Validation + lancement import
- [x] 15. Step 3 : Page r√©sultat (compteurs + erreurs + bouton dashboard)
- [x] 16. Redirect automatique vers `/onboarding` si nouvel utilisateur (RequireAuth)

### Phase 3 : Pages Read-Only (Priorit√© moyenne) ‚úÖ TERMIN√â (2026-02-21)
- [x] 17. Page Clients : table + page d√©tail client avec historique transactions
- [x] 18. Page Transactions : table + filtres (date, type, cat√©gorie) + totaux income/expense/net
- [x] 19. Page Engagements : liste + badges de statut
- [x] 20. Page Reports : historique QueryLog + rapports g√©n√©r√©s
- [x] 21. Page Settings : infos business + bouton "Re-import CSV"

### Phase 4 : Polish (Priorit√© basse)
- [ ] 22. Gestion d'erreurs globale (toasts, messages d'erreur)
- [ ] 23. Loading states et skeleton screens
- [ ] 24. Responsive design v√©rification
- [ ] 25. Test end-to-end du flow complet (signup ‚Üí onboarding ‚Üí import ‚Üí dashboard)

---

## üéØ Prochaines Actions Prioritaires (MVP Data-first)

### ~~Session 2026-02-17~~ ‚úÖ FAIT
1. ~~**üóÉÔ∏è Mod√®les Prisma**~~ ‚úÖ
2. ~~**üì¶ Backend Import**~~ ‚úÖ
3. ~~**üîå Endpoints**~~ ‚úÖ
4. ~~**üß™ Tests manuels**~~ ‚úÖ

### ~~Session 2026-02-17 (Frontend Onboarding)~~ ‚úÖ FAIT

### Session 2026-02-19 ‚Äî Pages Read-Only (en cours)
> üéì Mode guid√© : Claude explique quoi faire, pourquoi et comment. L'√©tudiant code.

- [x] 1. Setup `router.tsx` ‚Äî brancher toutes les nouvelles routes
- [x] 2. Setup `Sidebar.tsx` ‚Äî remplacer "Businesses" par "Transactions"
- [x] 3. Hook `useTransactions.ts` ‚Äî fetch GET /transactions (`response.data.items` ‚ö†Ô∏è)
- [x] 4. Page `TransactionsPage.tsx` ‚Äî cards r√©sum√© + filtre + table ‚úÖ FONCTIONNEL
- [ ] 5. Hook `useClients.ts` ‚Äî fetch GET /clients
- [ ] 6. Page `ClientPage.tsx` ‚Äî table cliquable
- [ ] 7. Hook `useClientDetail.ts` ‚Äî fetch GET /clients/:id + ses transactions + ses engagements
- [ ] 8. Page `ClientDetailPage.tsx` ‚Äî infos + engagements + transactions du client
- [ ] 9. Hook `useEngagements.ts` ‚Äî fetch GET /engagements
- [ ] 10. Page `EngagementPage.tsx` ‚Äî table cliquable
- [ ] 11. Hook `useEngagementDetail.ts` ‚Äî fetch GET /engagements/:id + ses items + ses transactions
- [ ] 12. Page `EngagementDetailPage.tsx` ‚Äî items + transactions li√©es
- [ ] 13. Page `ReportsPage.tsx` ‚Äî query logs + rapports IA
- [ ] 14. Page `SettingsPage.tsx` ‚Äî infos business + bouton re-import

### ‚ö†Ô∏è Le√ßon apprise (2026-02-19)
Le backend enveloppe ses r√©ponses dans un objet ‚Äî toujours v√©rifier le controller avant d'√©crire le hook :
- `GET /transactions` ‚Üí retourne `{ items: [...] }` ‚Üí utiliser `response.data.items`
- V√©rifier le pattern pour chaque endpoint avant de coder le hook correspondant

---

## üìö Notes P√©dagogiques ‚Äî Comprendre ce qu'on construit

> Cette section explique les concepts cl√©s utilis√©s dans le projet.
> √Ä lire pour comprendre les d√©cisions d'architecture.

---

### üîÑ Le pattern qu'on r√©p√®te sur chaque page

Chaque page read-only suit **toujours le m√™me sch√©ma** en 3 couches :

```
Hook (useXxx.ts)         ‚Üí fetch les donn√©es depuis l'API backend
Page (XxxPage.tsx)       ‚Üí affiche les donn√©es, g√®re loading/erreur
Composant UI (Card, Badge) ‚Üí mise en forme visuelle
```

**Pourquoi s√©parer le hook de la page ?**
Le hook s'occupe de la logique (appel API, √©tat loading, erreurs).
La page s'occupe uniquement de l'affichage.
‚Üí Plus facile √† relire, tester, et r√©utiliser.

---

### üõ£Ô∏è Comment fonctionne le routing (React Router)

```
router.tsx d√©finit les URLs de l'application :

/dashboard                ‚Üí DashboardPage
/dashboard/transactions   ‚Üí TransactionsPage
/dashboard/clients        ‚Üí ClientsPage
/dashboard/clients/:id    ‚Üí ClientDetailPage   ‚Üê :id = variable dans l'URL
/dashboard/engagements    ‚Üí EngagementsPage
/dashboard/engagements/:id ‚Üí EngagementDetailPage
/dashboard/reports        ‚Üí ReportsPage
/dashboard/settings       ‚Üí SettingsPage
```

**Qu'est-ce que `:id` ?**
C'est un param√®tre dynamique dans l'URL.
Ex: `/dashboard/clients/42` ‚Üí `:id` = 42
Dans le composant, on r√©cup√®re √ßa avec `useParams()` de React Router.

```tsx
const { id } = useParams(); // id = "42"
```

---

### ü™ù Ce qu'est un Hook React (useXxx)

Un hook est une **fonction r√©utilisable** qui encapsule de la logique React.

```ts
// Exemple : useClients.ts
export function useClients(businessId) {
  const [clients, setClients] = useState([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    // fetch les clients depuis l'API quand businessId change
    api.get(`/clients?business_id=${businessId}`)
      .then(res => setClients(res.data));
  }, [businessId]);

  return { clients, loading };
}

// Dans la page :
const { clients, loading } = useClients(selectedBusinessId);
```

**Pourquoi `useEffect` ?**
`useEffect` s'ex√©cute apr√®s le rendu.
Le tableau `[businessId]` = "relance l'effet si businessId change".

---

### üèóÔ∏è Diff√©rence Engagement vs Transaction (rappel)

| Concept | Analogie boutique Michael | Dans le code |
|---------|--------------------------|--------------|
| **Engagement** | Une commande client (contrat) | `Engagement` avec statut draft/active/completed |
| **EngagementItem** | Les produits dans la commande | `EngagementItem` avec qty √ó prix |
| **Transaction** | L'argent re√ßu/pay√© r√©ellement | `Transaction` income/expense |

Un engagement = la **promesse**. Une transaction = l'**argent qui bouge**.

---

### üé® Composants UI r√©utilis√©s

```tsx
<Card className="p-6">          // conteneur arrondi avec fond semi-transparent
<Badge className="...">         // petit label color√© (statut, type)
```

Pour les couleurs de badge selon le contexte :
- `income` ‚Üí vert  (`text-emerald-300 bg-emerald-500/10`)
- `expense` ‚Üí rouge (`text-red-300 bg-red-500/10`)
- `active`  ‚Üí bleu  (`text-blue-300 bg-blue-500/10`)
- `draft`   ‚Üí gris  (`text-white/50 bg-white/5`)
- `completed` ‚Üí vert (`text-emerald-300 bg-emerald-500/10`)
- `cancelled` ‚Üí rouge (`text-red-300 bg-red-500/10`)

---

## üìä M√©triques de Progression MVP

| Cat√©gorie | Backend | Frontend | Statut MVP |
|-----------|---------|----------|------------|
| **Authentification** | 100% ‚úÖ | 100% ‚úÖ | ‚úÖ COMPLET |
| **Gestion Business** | 100% ‚úÖ | 100% ‚úÖ | ‚úÖ COMPLET |
| **Dashboard** | 100% ‚úÖ | 100% ‚úÖ | ‚úÖ COMPLET |
| **IA Assistant** | 100% ‚úÖ | 100% ‚úÖ | ‚úÖ COMPLET |
| **Onboarding** | 100% ‚úÖ | 100% ‚úÖ | ‚úÖ COMPLET |
| **Import CSV Intelligent** | 100% ‚úÖ | 100% ‚úÖ | ‚úÖ COMPLET |
| **Page Clients (read-only)** | 100% ‚úÖ | 0% ‚ùå | ‚ùå Frontend manquant |
| **Page Transactions (read-only)** | 100% ‚úÖ | 0% ‚ùå | ‚ùå Frontend manquant |
| **Page Engagements (read-only)** | 100% ‚úÖ | 0% ‚ùå | ‚ùå Frontend manquant |
| **Page Reports (read-only)** | 100% ‚úÖ | 0% ‚ùå | ‚ùå Frontend manquant |
| **Page Settings** | 100% ‚úÖ | 0% ‚ùå | ‚ùå Frontend manquant |

### L√©gende
- ‚úÖ **COMPLET** : Pr√™t pour MVP
- ‚ö†Ô∏è **PARTIEL** : Utilisable mais am√©liorable
- ‚ùå **MANQUANT** : √Ä faire pour MVP complet

---

## üîß Configuration Requise

### Variables d'environnement Backend (.env)
```env
DATABASE_URL=postgresql://...
JWT_SECRET=...
PORT=3000
OPENAI_API_KEY=...
KAIROS_EXTRACTOR_KEY=kairos_dev_secret
KAIROS_EXTRACTOR_URL=http://localhost:8001
```

### Variables d'environnement Frontend (.env)
```env
VITE_API_BASE_URL=http://localhost:3000
```

### Commandes de d√©marrage
```bash
# Backend
cd Kairos-backend
npm run dev

# Frontend
cd kairos-frontend
npm run dev

# Service Python (optionnel)
cd Kairos-backend/python-extractor
uvicorn app.main:app --reload --port 8001
```

---

## üìù Notes Importantes

### Conventions de Code
- **TypeScript strict mode** activ√©
- **Nomenclature :**
  - Fichiers : camelCase pour les fichiers TS/JS, PascalCase pour les composants React
  - Variables : camelCase
  - Types : PascalCase
  - Constantes : UPPER_SNAKE_CASE
- **Architecture :** Toujours suivre le pattern Routes ‚Üí Controllers ‚Üí Services
- **S√©curit√© :** Toujours utiliser `requireAuth` + `requireBusinessAccess` pour les endpoints sensibles

### Bugs Connus

#### ~~Bug 1 : IA ne voit pas les noms de clients apr√®s import CSV~~ ‚úÖ CORRIG√â (2026-02-22)
- **Sympt√¥me :** La query "qui est mon meilleur client" r√©pondait "le nom n'est pas sp√©cifi√©" ou SERVER_ERROR
- **Cause r√©elle (3 probl√®mes) :**
  1. `JSON.stringify` ne peut pas s√©rialiser les `BigInt` retourn√©s par `COUNT()`/`SUM()` PostgreSQL ‚Üí SERVER_ERROR en fran√ßais
  2. Le sch√©ma clients fourni √† l'IA ne contenait pas `company_name` ‚Üí l'IA ne savait pas que les clients CSV n'ont que ce champ
  3. L'IA g√©n√©rait un JOIN sur `c.business_id = t.business_id` (faux) au lieu de `c.id_client = t.client_id`
- **Fix appliqu√© dans `aiService.ts` :**
  - Replacer BigInt dans `JSON.stringify` : `(_, v) => typeof v === "bigint" ? Number(v) : v`
  - Ajout de `company_name` dans le sch√©ma clients du prompt
  - Ajout de `client_id` dans le sch√©ma transactions du prompt
  - Nouvel intent `BEST_CLIENT` dans `guessIntent()` avec r√®gles SQL explicites (COALESCE + bon JOIN)
  - Instruction COALESCE : `COALESCE(c.company_name, CONCAT(c.first_name, ' ', c.last_name)) AS client_name`
- **Note importante :** Le bug n'appara√Æt QUE si le CSV avait une colonne `client_name` mapp√©e. Sans cette colonne, `client_id = NULL` sur les transactions ‚Üí l'IA ne peut pas trouver les noms (c'est normal, pas un bug).

#### Bug 2 : Graphiques ne s'affichent pas apr√®s import CSV
- **Sympt√¥me :** RevenueLineChart et ExpensePieChart vides apr√®s import des donn√©es
- **√Ä investiguer :** V√©rifier si les endpoints `/dashboard/monthly-trend` et `/dashboard/expenses-by-category` retournent des donn√©es non-vides apr√®s import, et si le format de date/montant des donn√©es import√©es correspond √† ce qu'attendent les requ√™tes dashboard

#### CSV de test (tech/SaaS, Jan-Mar 2025, Qu√©bec)
```
date,type,amount,category,client_name,description,payment_method
2025-01-01,expense,7754.0,Taxes,,Frais de consultation juridique,transfer
2025-01-01,income,849.0,Abonnements,Ville de Laval,Int√©gration API + formation,transfer
...clients: Ville de Laval, √âcoTrans Logistique, Manufacture Atlas, Assurance Bor√©ale, Studio Pixel&Co, Groupe Immobilier Horizon, Universit√© du Qu√©bec, Clinique Nova Sant√©, Startup M√©t√©ore, Cabinet Lavoie & Associ√©s, Nordik Finance Inc.
```

### Am√©liorations Techniques Future

#### IA & Intelligence
- [ ] **Am√©liorer la d√©tection d'intent pour "analyse mes revenues"** : Quand l'utilisateur demande une analyse, automatiquement aller chercher AUSSI les d√©penses pour fournir une analyse compl√®te (revenus + d√©penses + net) au lieu de juste les revenus. Actuellement, l'utilisateur doit explicitement demander "analyse financi√®re compl√®te" pour obtenir les deux.
- [ ] Ajouter support pour les graphiques g√©n√©r√©s par l'IA
- [ ] Historique des questions pos√©es √† l'IA (accessible via UI)

#### Infrastructure & Tests
- [ ] Migration vers React Query pour le state management serveur
- [ ] Ajout de tests unitaires (Jest + React Testing Library)
- [ ] Ajout de tests E2E (Playwright)
- [ ] Dockerisation compl√®te
- [ ] CI/CD avec GitHub Actions
- [ ] Monitoring et logging (Sentry)

---

## üìö Ressources

- [Documentation Prisma](https://www.prisma.io/docs)
- [Documentation React Router](https://reactrouter.com/)
- [Documentation TailwindCSS](https://tailwindcss.com/docs)
- [API OpenAI](https://platform.openai.com/docs)

---

## üéØ Objectif MVP Final

**Pour la pr√©sentation scolaire, on doit avoir :**
1. ‚úÖ Dashboard fonctionnel avec vraies donn√©es
2. ‚úÖ **Graphiques de visualisation** ‚úÖ TERMIN√â (2026-02-15)
3. ‚úÖ **Assistant IA Kairos fonctionnel** ‚úÖ TERMIN√â (2026-02-06)
4. ‚úÖ Upload et analyse de documents
5. ‚úÖ Gestion des clients et business
6. ‚úÖ **Onboarding + Import CSV Intelligent** ‚úÖ TERMIN√â (2026-02-17)
7. ‚ùå **Pages read-only** : Clients, Transactions, Engagements, Reports, Settings (√Ä FAIRE)

---

**üéØ Session 2026-02-15 : Dashboard Graphiques - SUCC√àS ‚úÖ**
- ‚úÖ Donn√©es de test ajout√©es (20 transactions seed : 10 income + 10 expense)
- ‚úÖ 2 nouveaux endpoints backend : `monthly-trend` + `expenses-by-category`
- ‚úÖ Hook `useDashboard()` mis √† jour (5 appels API en parall√®le)
- ‚úÖ Composant `RevenueLineChart` : Line chart revenu vs d√©penses sur 6 mois
- ‚úÖ Composant `ExpensePieChart` : Donut chart d√©penses par cat√©gorie
- ‚úÖ Int√©gration dans DashboardPage avec loading states
- ‚úÖ Recharts install√© et configur√©

**üéØ Session 2026-02-17 : Pivot MVP Data-first + Backend Import - SUCC√àS ‚úÖ**
- Nouveau scope : Import CSV Intelligent assist√© par IA
- Pages read-only (pas de CRUD complet)
- Abandon du d√©ploiement Vercel pour l'instant
- Phase 1 Backend compl√©t√©e :
  - ‚úÖ Mod√®les Prisma `ImportJob` + `ImportRowError` + migration
  - ‚úÖ `csvParserService.ts` : parsing CSV + preview
  - ‚úÖ `columnMappingService.ts` : heuristique + appel IA OpenAI
  - ‚úÖ `importService.ts` + `importHelpers.ts` : normalisation + validation + insertion
  - ‚úÖ Controllers + Routes (`/onboarding/*`, `/import/*`)
  - ‚úÖ Tests curl : preview OK, import 5/5 lignes, 0 erreurs

**üéØ Session 2026-02-17 : Frontend Onboarding - SUCC√àS ‚úÖ**
- ‚úÖ Wizard 3 √©tapes : Business ‚Üí CSV Import ‚Üí R√©sultat
- ‚úÖ `BusinessInfoStep.tsx` : formulaire business + appel `/onboarding/business`
- ‚úÖ `CsvWizardStep.tsx` : upload + preview + mapping IA + import
- ‚úÖ `ImportResultStep.tsx` : compteurs + erreurs + redirect dashboard
- ‚úÖ `OnboardingPage.tsx` : wizard parent avec progress bar 3 steps
- ‚úÖ `RequireAuth.tsx` : redirect auto vers `/onboarding` si 0 businesses
- ‚úÖ Mode d√©mo retir√©, texte blanc (text-white sur wrapper)
- ‚úÖ Bugs backend corrig√©s : `user_id` (pas `id_user`), `mappings` (pluriel), cl√© `preview`

**üéØ Session 2026-02-21 ‚Äî Pages Read-Only - SUCC√àS ‚úÖ**
- ‚úÖ `useClients` + `ClientPage` + `useClientDetail` + `ClientDetailPage`
- ‚úÖ `useEngagements` + `EngagementPage` + `useEngagementsDetails` + `EngagementDetailPage`
- ‚úÖ `useReports` + `ReportsPage`
- ‚úÖ `SettingsPage` + re-import CSV (saute le step Business via router state)
- ‚úÖ Convention √©tablie : tous les GET API dans des hooks (useXxx)

**üéØ Session 2026-02-22 ‚Äî Bugs & Code Clean - SUCC√àS ‚úÖ**
- ‚úÖ Suppression imports inutilis√©s (`TransactionType`, `me`, `use`)
- ‚úÖ Suppression `console.log("JWT_SECRET loaded?")` debug
- ‚úÖ Typos corrig√©s : `metrcis` ‚Üí `metrics` (√ó2), `buisness_type` ‚Üí `business_type`
- ‚úÖ Fix `$NaN` dans `EngagementDetailPage` : `item.description`‚Üí`item.item_name`, `item.total_price`‚Üí`item.line_total`
- ‚úÖ Bug 1 corrig√© : AskKairos retourne maintenant les vrais noms de clients (BigInt + JOIN + sch√©ma)
- ‚úÖ Commentaires ajout√©s sur les hooks et services principaux

**üéØ Prochaine session**
1. **üêõ Corriger Bug 2 graphiques** : v√©rifier pourquoi les charts sont vides apr√®s import CSV (endpoints `/dashboard/monthly-trend` et `/dashboard/expenses-by-category`)
2. **üé® Phase 4 Polish** (optionnel) : toasts d'erreur, skeleton screens, test E2E

---

### üß† Patterns & Pi√®ges √† retenir

#### Prisma + BigInt
PostgreSQL retourne `COUNT()` et `SUM()` comme `BigInt`. `JSON.stringify()` plante.
Toujours utiliser le replacer : `JSON.stringify(data, (_, v) => typeof v === "bigint" ? Number(v) : v)`

#### Noms de clients (CSV vs Manuel)
- Clients cr√©√©s **manuellement** ‚Üí `first_name` + `last_name` remplis, `company_name` NULL
- Clients import√©s **via CSV** ‚Üí seul `company_name` est rempli (via `findOrCreateClient`)
- Toujours utiliser : `COALESCE(c.company_name, CONCAT(c.first_name, ' ', c.last_name))`

#### JOIN transactions ‚Üí clients
- Cl√© de relation : `c.id_client = t.client_id` ‚Üê **CORRECT**
- Pi√®ge fr√©quent IA : `c.business_id = t.business_id` ‚Üê **FAUX** (croise tous les clients avec toutes les transactions)
- Si `t.client_id = NULL`, le LEFT JOIN retourne NULL pour tous les champs client ‚Üí normal si la transaction n'a pas de client li√©

#### Champs Prisma (frontend doit correspondre)
- `EngagementItem` : `item_name` et `line_total` (PAS `description` / `total_price`)
- `Transaction` : `client_id` (FK optionnel vers `clients.id_client`)

_Derni√®re mise √† jour PLAN.MD : 2026-02-22 - Bug 1 IA corrig√© + patterns document√©s_
